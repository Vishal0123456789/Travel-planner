<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Travel Planner - Companion UI</title>
    <link rel="stylesheet" href="/leaflet/leaflet.css" />
    <script src="/leaflet/leaflet.js"></script>

    <style>
        :root {
            --primary: #2563eb;
            --bg: #f8fafc;
            --surface: #ffffff;
            --text-main: #1e293b;
            --text-muted: #64748b;
            --border: #e2e8f0;
            --warning: #f59e0b;
            --success: #10b981;
            --danger: #ef4444;
            --day1: #2563eb;
            /* Blue */
            --day2: #ef4444;
            /* Red */
            --day3: #10b981;
            /* Green */
            --day4: #a855f7;
            /* Purple */
        }

        body {
            font-family: 'Inter', system-ui, sans-serif;
            margin: 0;
            display: flex;
            height: 100vh;
            background: var(--bg);
            color: var(--text-main);
        }

        /* Layout */
        .app-container {
            display: flex;
            width: 100%;
            height: 100%;
        }

        .sidebar {
            width: 400px;
            border-right: 1px solid var(--border);
            background: var(--surface);
            display: flex;
            flex-direction: column;
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Chat / Input Area */
        .chat-area {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            background: #f1f5f9;
        }

        .input-area {
            padding: 1rem;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 0.5rem;
            background: var(--surface);
        }

        .input-area input {
            flex: 1;
            padding: 0.75rem;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 1rem;
        }

        .btn-circle {
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .btn-circle:disabled {
            background: var(--text-muted);
            cursor: not-allowed;
        }

        .btn-stop {
            background: var(--danger);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 0.65rem;
            font-weight: 700;
            cursor: pointer;
            margin-left: 8px;
            text-transform: uppercase;
        }

        .btn-mic.listening {
            background: var(--danger);
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
            }

            70% {
                transform: scale(1.1);
                box-shadow: 0 0 0 10px rgba(239, 68, 68, 0);
            }

            100% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0);
            }
        }

        .speaking-indicator {
            display: none;
            gap: 3px;
            align-items: center;
            margin-right: 1rem;
        }

        .speaking-indicator span {
            width: 3px;
            height: 15px;
            background: var(--primary);
            animation: bar-pulse 1s infinite ease-in-out;
        }

        @keyframes bar-pulse {

            0%,
            100% {
                height: 5px;
            }

            50% {
                height: 15px;
            }
        }

        /* Itinerary View */
        .itinerary-view {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        .timeline {
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem;
            max-width: 500px;
            border-right: 1px solid var(--border);
            background: var(--surface);
        }

        .map-section {
            flex: 1;
            position: relative;
        }

        #map {
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        /* Legend */
        .map-legend {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: white;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid var(--border);
            z-index: 1000;
            font-size: 0.8rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 4px;
        }

        .dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        /* Components */
        .day-header {
            margin-bottom: 1.5rem;
            border-bottom: 2px solid var(--border);
            padding-bottom: 0.75rem;
        }

        .day-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            margin-bottom: 1.5rem;
            padding: 1rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.02);
        }

        .block-title {
            color: var(--text-muted);
            text-transform: uppercase;
            font-size: 0.7rem;
            font-weight: 700;
            letter-spacing: 1px;
            margin-bottom: 0.5rem;
            margin-top: 1rem;
        }

        .activity-item {
            display: flex;
            gap: 1rem;
            padding: 0.75rem 0;
            border-bottom: 1px solid #f1f5f9;
        }

        .activity-time {
            font-variant-numeric: tabular-nums;
            color: var(--text-muted);
            width: 50px;
            font-size: 0.85rem;
            line-height: 1.4;
        }

        .activity-details {
            flex: 1;
        }

        .activity-details strong {
            display: block;
            margin-bottom: 2px;
        }

        .travel-line {
            margin: 0.5rem 0;
            padding-left: 1rem;
            font-size: 0.8rem;
            color: var(--text-muted);
            border-left: 2px solid var(--border);
            font-style: italic;
        }

        .eval-badge {
            display: inline-block;
            padding: 0.25rem 0.6rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 700;
        }

        .eval-pass {
            background: #d1fae5;
            color: #065f46;
        }

        .eval-fail {
            background: #fee2e2;
            color: #991b1b;
        }

        .eval-warn {
            background: #fef3c7;
            color: #92400e;
        }

        .citation {
            font-size: 0.75rem;
            color: var(--primary);
            margin-top: 0.4rem;
            font-style: italic;
        }

        /* Detailed Report Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background-color: var(--surface);
            margin: 10% auto;
            padding: 2rem;
            border-radius: 16px;
            width: 500px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }

        .report-section {
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border);
        }

        .report-section h3 {
            margin-top: 0;
            font-size: 1rem;
            display: flex;
            justify-content: space-between;
        }

        .verified-badge {
            background: #dbeafe;
            color: #1e40af;
            font-size: 0.65rem;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 700;
            text-transform: uppercase;
            margin-left: 8px;
            display: inline-flex;
            align-items: center;
            gap: 2px;
        }

        .day-totals {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: 4px;
            display: flex;
            gap: 12px;
        }

        .btn-text {
            color: var(--primary);
            cursor: pointer;
            font-weight: 600;
            font-size: 0.85rem;
            background: none;
            border: none;
            padding: 0;
            text-decoration: underline;
        }

        /* Email Section */
        .email-section {
            padding: 1.5rem;
            border-top: 1px solid var(--border);
            background: #f8fafc;
            display: none;
            flex-direction: column;
            gap: 0.75rem;
        }

        .email-input {
            padding: 0.75rem;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 0.9rem;
            width: 100%;
            box-sizing: border-box;
        }

        .btn-email {
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .btn-email:hover {
            opacity: 0.9;
        }
    </style>
</head>

<body>
    <!-- Detailed Report Modal -->
    <div id="reportModal" class="modal">
        <div class="modal-content">
            <h2 style="margin-top: 0;">Evaluation Report</h2>
            <div id="report-body"></div>
            <button class="btn-mic" style="width: 100%; border-radius: 8px; margin-top: 1rem;"
                onclick="closeModal()">Close Report</button>
        </div>
    </div>
    <div class="app-container">
        <!-- Left: Interaction -->
        <div class="sidebar">
            <div class="chat-area" id="chat-log">
                <div style="text-align: center; color: var(--text-muted); margin-top: 2rem; padding: 1rem;">
                    <h3>Udaipur Trip Planner</h3>
                    <p>Try: "Plan a 3 day trip" or "Add a boat ride on day 2"</p>
                </div>
            </div>
            <div class="input-area">
                <button id="micBtn" class="btn-circle btn-mic" onclick="toggleListening()"
                    title="Voice Input">üé§</button>
                <input type="text" id="userInput" placeholder="Type a request..." autofocus />
                <button id="sendBtn" class="btn-circle" onclick="sendMessage()" title="Send Message">‚û§</button>
            </div>
        </div>

        <!-- Right: Visualization -->
        <div class="main-content">
            <div id="eval-banner"
                style="background: var(--surface); border-bottom: 1px solid var(--border); padding: 0.75rem 1.5rem; display: flex; align-items: center; justify-content: space-between;">
                <div style="display: flex; align-items: center;">
                    <div id="speakingIndicator" class="speaking-indicator">
                        <span></span><span style="animation-delay: 0.2s"></span><span
                            style="animation-delay: 0.4s"></span>
                        <button class="btn-stop" onclick="stopSpeaking()">Stop</button>
                    </div>
                    <span style="font-weight: 600; color: var(--text-muted); font-size: 0.9rem;">Status:</span>
                    <span id="eval-status" class="eval-badge eval-pass">Ready</span>
                    <button id="view-report-btn" class="btn-text" style="display: none; margin-left: 1rem;"
                        onclick="openModal()">View Detailed Report</button>
                </div>
                <div id="eval-warnings" style="font-size: 0.8rem; color: var(--warning); display: none;">
                    ‚ö†Ô∏è Warnings present
                </div>
            </div>

            <div class="itinerary-view">
                <!-- Itinerary Timeline -->
                <div class="timeline" style="display: flex; flex-direction: column;">
                    <div id="itinerary-render" style="flex: 1; padding: 1.5rem;">
                        <div style="text-align: center; color: var(--text-muted); margin-top: 5rem;">
                            No itinerary loaded yet.
                        </div>
                    </div>
                    <div id="email-controls" class="email-section">
                        <label style="font-size: 0.8rem; font-weight: 600; color: var(--text-muted);">Email Me This
                            Itinerary</label>
                        <input type="email" id="userEmail" class="email-input" placeholder="your@email.com" />
                        <button class="btn-email" onclick="sendItineraryToN8N()">Send via Email</button>
                    </div>
                </div>

                <!-- Map Visualization -->
                <div class="map-section">
                    <div id="map"></div>
                    <div class="map-legend">
                        <div class="legend-item">
                            <div class="dot" style="background: var(--day1)"></div>Day 1
                        </div>
                        <div class="legend-item">
                            <div class="dot" style="background: var(--day2)"></div>Day 2
                        </div>
                        <div class="legend-item">
                            <div class="dot" style="background: var(--day3)"></div>Day 3
                        </div>
                        <div class="legend-item">
                            <div class="dot" style="background: var(--day4)"></div>Day 4+
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const input = document.getElementById('userInput');
        const chatLog = document.getElementById('chat-log');
        const timeline = document.getElementById('itinerary-render');
        const reportModal = document.getElementById('reportModal');
        const reportBody = document.getElementById('report-body');
        const emailControls = document.getElementById('email-controls');
        const micBtn = document.getElementById('micBtn');
        const sendBtn = document.getElementById('sendBtn');
        const speakingIndicator = document.getElementById('speakingIndicator');

        let map;
        let mapLayers = { markers: [], routes: [] };
        let lastEvals = null;
        let lastRagSources = {};
        let currentItinerary = null;
        let isListening = false;
        let isLoading = false;

        // Session Management
        const sessionId = sessionStorage.getItem('tp_session_id') ||
            `sess_${Date.now()}_${Math.random().toString(36).substring(2, 9)}`;
        sessionStorage.setItem('tp_session_id', sessionId);

        const DAY_COLORS = ['#2563eb', '#ef4444', '#10b981', '#a855f7'];

        // Speech Configuration
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition = null;

        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.lang = 'en-IN';
            recognition.interimResults = false;

            recognition.onstart = () => {
                isListening = true;
                micBtn.classList.add('listening');
            };

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                input.value = transcript;
                sendMessage();
            };

            recognition.onerror = (event) => {
                console.error("Speech Recognition Error:", event.error);
                appendLog("Speech Error: " + event.error, 'ai');
                stopListening();
            };

            recognition.onend = () => {
                stopListening();
            };
        } else {
            micBtn.style.display = 'none';
        }

        function toggleListening() {
            if (isListening) stopListening();
            else startListening();
        }

        function startListening() {
            if (!recognition || isLoading) return;
            try {
                recognition.start();
                isListening = true;
                micBtn.classList.add('listening');
            } catch (e) {
                console.error(e);
            }
        }

        function stopListening() {
            if (!recognition) return;
            recognition.stop();
            isListening = false;
            micBtn.classList.remove('listening');
        }

        function speakItinerary(responseText, evals, itinerary) {
            window.speechSynthesis.cancel();

            let textToSpeak = responseText;

            // If evaluation fails significantly, prepend a warning
            if (evals && !evals.passed) {
                textToSpeak = "Note: This plan has some timing issues. " + textToSpeak;
            }

            // Clean markdown for smoother reading
            const cleanText = textToSpeak
                .replace(/\*\*/g, '')      // Bold
                .replace(/\*/g, '')       // Bullets/Italic
                .replace(/#/g, '')        // Headers
                .replace(/\[|\]/g, '')    // Brackets
                .replace(/üöó/g, 'Travel ') // Emojis
                .replace(/\n+/g, '. ');    // Newlines to pauses

            const utterance = new SpeechSynthesisUtterance(cleanText);
            utterance.lang = 'en-IN';
            utterance.rate = 1.0;
            utterance.pitch = 1.0;

            utterance.onstart = () => {
                speakingIndicator.style.display = 'flex';
            };
            utterance.onend = () => {
                speakingIndicator.style.display = 'none';
            };

            window.speechSynthesis.speak(utterance);
        }

        function stopSpeaking() {
            window.speechSynthesis.cancel();
            speakingIndicator.style.display = 'none';
        }

        function initMap() {
            map = L.map('map').setView([24.5854, 73.7125], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors'
            }).addTo(map);
        }

        function openModal() { reportModal.style.display = 'block'; }
        function closeModal() { reportModal.style.display = 'none'; }

        function appendLog(text, sender, citation = null) {
            const div = document.createElement('div');
            div.style.marginBottom = '12px';
            div.style.padding = '12px';
            div.style.borderRadius = '12px';
            div.style.fontSize = '0.95rem';

            if (sender === 'user') {
                div.style.background = '#ffffff';
                div.style.marginLeft = '20px';
                div.style.border = '1px solid #e2e8f0';
            } else {
                div.style.background = '#e2e8f0';
                div.style.marginRight = '20px';
            }

            const content = document.createElement('div');
            content.innerText = text;
            div.appendChild(content);

            if (citation && citation.source_name) {
                const citeDiv = document.createElement('div');
                citeDiv.className = 'citation';
                citeDiv.innerHTML = `Source: <a href="${citation.source_url}" target="_blank" style="color: var(--primary); text-decoration: none;">${citation.source_name}</a>`;
                div.appendChild(citeDiv);
            }

            chatLog.appendChild(div);
            chatLog.scrollTop = chatLog.scrollHeight;
        }

        function updateEvalBanner(evals) {
            lastEvals = evals;
            const banner = document.getElementById('eval-status');
            const warnDiv = document.getElementById('eval-warnings');
            const reportBtn = document.getElementById('view-report-btn');

            if (!evals) return;

            reportBtn.style.display = 'inline-block';

            if (evals.passed) {
                banner.innerText = "PASSED (" + (evals.feasibility?.feasibilityScore || 100) + ")";
                banner.className = "eval-badge eval-pass";
            } else {
                banner.innerText = "FAILED";
                banner.className = "eval-badge eval-fail";
            }

            warnDiv.style.display = (evals.feasibility?.warnings.length > 0) ? 'block' : 'none';

            // Populate Report
            let html = `
                <div class="report-section">
                    <h3>Feasibility Score <span>${evals.feasibility?.feasibilityScore}/100</span></h3>
                    <p style="color: ${evals.feasibility?.pass ? 'var(--success)' : 'var(--danger)'}; font-weight: 700;">
                        ${evals.feasibility?.pass ? '‚úÖ Plan meets all time constraints.' : '‚ùå Plan exceeds recommended limits.'}
                    </p>
                </div>
            `;

            if (evals.feasibility?.errors?.length > 0) {
                html += `
                    <div class="report-section">
                        <h4 style="margin: 0 0 8px 0; color: var(--danger);">Critical Issues</h4>
                        <ul style="padding-left: 1.2rem; font-size: 0.85rem; color: var(--danger); font-weight: 500;">
                            ${evals.feasibility.errors.map(e => `<li>${e}</li>`).join('')}
                        </ul>
                    </div>
                `;
            }

            if (evals.feasibility?.warnings?.length > 0) {
                html += `
                    <div class="report-section">
                        <h4 style="margin: 0 0 8px 0; color: var(--warning);">Efficiency Warnings</h4>
                        <ul style="padding-left: 1.2rem; font-size: 0.85rem; color: var(--text-muted);">
                            ${evals.feasibility.warnings.map(w => `<li>${w}</li>`).join('')}
                        </ul>
                    </div>
                `;
            }

            if (evals.grounding?.errors?.length > 0) {
                html += `
                    <div class="report-section">
                        <h4 style="margin: 0 0 8px 0; color: var(--danger);">Grounding Failures</h4>
                        <ul style="padding-left: 1.2rem; font-size: 0.85rem; color: var(--danger);">
                            ${evals.grounding.errors.map(e => `<li>${e}</li>`).join('')}
                        </ul>
                    </div>
                `;
            }

            html += `
                <div class="report-section" style="border-bottom: none;">
                    <h4 style="margin: 0 0 8px 0;">Verification Status</h4>
                    <p style="font-size: 0.85rem; color: ${evals.grounding?.pass ? 'var(--success)' : 'var(--warning)'}">
                        ${evals.grounding?.pass ? '‚úÖ All POIs verified against regional database.' : '‚ö†Ô∏è Some locations pending verification.'}
                    </p>
                </div>
            `;

            reportBody.innerHTML = html;
        }

        function clearMap() {
            mapLayers.markers.forEach(m => map.removeLayer(m));
            mapLayers.routes.forEach(r => map.removeLayer(r));
            mapLayers.markers = [];
            mapLayers.routes = [];
        }

        function renderMap(itinerary) {
            clearMap();
            if (!itinerary || !itinerary.days) return;
            const boundsArr = [];

            itinerary.days.forEach((day, dIdx) => {
                const color = DAY_COLORS[dIdx] || '#64748b';
                const routeCoords = [];
                day.blocks.forEach(block => {
                    block.activities.forEach(act => {
                        const latLng = [act.geo_coordinates.lat, act.geo_coordinates.lon];
                        routeCoords.push(latLng);
                        boundsArr.push(latLng);
                        const marker = L.circleMarker(latLng, {
                            radius: 8, fillColor: color, color: '#fff', weight: 2, opacity: 1, fillOpacity: 0.9
                        }).addTo(map);
                        marker.bindTooltip(`<strong>${act.name}</strong><br>${act.start_time} - ${act.end_time}`);
                        mapLayers.markers.push(marker);
                    });
                });
                if (routeCoords.length > 1) {
                    const polyline = L.polyline(routeCoords, { color: color, weight: 5, opacity: 0.7 }).addTo(map);
                    mapLayers.routes.push(polyline);
                }
            });
            if (boundsArr.length > 0) map.fitBounds(L.latLngBounds(boundsArr), { padding: [50, 50] });
        }

        function renderTimeline(itinerary, evals) {
            if (!itinerary || !itinerary.days) return;
            timeline.innerHTML = '';

            const ungrounded = evals?.grounding?.ungroundedIds || [];

            itinerary.days.forEach(day => {
                const daySummary = evals?.feasibility?.dailySummary?.find(s => s.day === day.day_number);

                const dayDiv = document.createElement('div');
                dayDiv.className = 'day-header';
                dayDiv.innerHTML = `
                    <h2 style="margin-bottom: 4px;">Day ${day.day_number}</h2>
                    <div class="day-totals">
                        <span>üïí Active: ${daySummary ? Math.round(daySummary.activityMinutes / 60) + 'h ' + (daySummary.activityMinutes % 60) + 'm' : '---'}</span>
                        <span>üöó Travel: ${daySummary ? daySummary.travelMinutes + 'm' : '---'}</span>
                    </div>
                `;
                timeline.appendChild(dayDiv);

                const card = document.createElement('div');
                card.className = 'day-card';

                day.blocks.forEach(block => {
                    if (block.activities.length === 0) return;
                    const blockTitle = document.createElement('div');
                    blockTitle.className = 'block-title';
                    blockTitle.innerText = block.name;
                    card.appendChild(blockTitle);

                    block.activities.forEach(act => {
                        const isVerified = !ungrounded.includes(act.poi_id);
                        const rag = lastRagSources ? lastRagSources[act.poi_id] : null;
                        const sourceLink = (isVerified && rag && rag.source_url)
                            ? `<a href="${rag.source_url}" target="_blank" class="verified-badge">‚úì Verified</a>`
                            : isVerified ? `<span class="verified-badge">‚úì Verified</span>` : '';

                        const actDiv = document.createElement('div');
                        actDiv.className = 'activity-item';
                        actDiv.innerHTML = `
                            <div class="activity-time">${act.start_time}<br><small>${act.end_time}</small></div>
                            <div class="activity-details">
                                <strong>${act.name} ${sourceLink}</strong>
                                <div style="font-size: 0.8rem; color: var(--text-muted);">${act.type} ‚Ä¢ ${act.duration_minutes}m</div>
                            </div>
                        `;
                        card.appendChild(actDiv);

                        if (act.travel_time_to_next_minutes > 0) {
                            const travelDiv = document.createElement('div');
                            travelDiv.className = 'travel-line';
                            travelDiv.innerText = `üöó ${act.travel_time_to_next_minutes} min travel`;
                            card.appendChild(travelDiv);
                        }
                    });
                });
                timeline.appendChild(card);
            });
        }

        async function sendMessage() {
            const text = input.value;
            if (!text || isLoading) return;

            isLoading = true;
            micBtn.disabled = true;
            sendBtn.disabled = true;
            appendLog(text, 'user');
            input.value = '';

            try {
                const res = await fetch('/api/message', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: text,
                        sessionId: sessionId
                    })
                });
                const data = await res.json();
                appendLog(data.text || data.error, 'ai', data.citation);

                if (data.itinerary) {
                    currentItinerary = data.itinerary;
                    lastRagSources = data.ragSources || {};
                    emailControls.style.display = 'flex';
                    renderTimeline(data.itinerary, data.evaluations);
                    renderMap(data.itinerary);
                    updateEvalBanner(data.evaluations);

                    // PART 4: Speak the summary
                    speakItinerary(data.text, data.evaluations, data.itinerary);
                }
            } catch (err) {
                console.error(err);
                appendLog("Error: " + err.message, 'ai');
            } finally {
                isLoading = false;
                micBtn.disabled = false;
                sendBtn.disabled = false;
            }
        }

        async function sendItineraryToN8N() {
            const email = document.getElementById('userEmail').value;
            if (!email) {
                alert("Please enter a valid email address.");
                return;
            }

            if (!currentItinerary) {
                alert("No itinerary available to send.");
                return;
            }

            try {
                const response = await fetch('/api/send-email', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: email,
                        itinerary: currentItinerary
                    })
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    alert("Itinerary sent successfully.");
                } else {
                    alert("Failed to send itinerary: " + (result.error || "Unknown error"));
                }

            } catch (err) {
                console.error("Email Proxy Error:", err);
                alert("Error connecting to email service.");
            }
        }

        input.addEventListener('keypress', (e) => { if (e.key === 'Enter') sendMessage(); });
        initMap();
    </script>
</body>

</html>